{% extends 'base.html' %}

{% block title %}Cronograma{% endblock %}

{% block content %}
<style>
    .viagem-card {
        border-left: 5px solid #ff6b6b;
        transition: all 0.3s ease;
    }
    
    .viagem-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .viagem-card.ativo {
        border-left-color: #51cf66;
    }
    
    .status-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .status-em-rota {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .info-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        font-size: 0.95rem;
    }
    
    .info-item i {
        width: 20px;
        margin-right: 10px;
        color: #0d6efd;
    }
    
    .info-label {
        font-weight: 600;
        min-width: 120px;
        color: #495057;
    }
    
    .info-value {
        color: #212529;
    }
    
    .cronograma-grid {
        display: grid;
        gap: 1.5rem;
    }
    
    .timeline-item {
        position: relative;
        padding-left: 30px;
        margin-bottom: 15px;
    }
    
    .timeline-item:before {
        content: '';
        position: absolute;
        left: 0;
        top: 5px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #0d6efd;
    }
    
    .veiculo-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px 8px 0 0;
    }
    
    .veiculo-placa {
        font-size: 1.3rem;
        font-weight: bold;
        font-family: monospace;
        background-color: rgba(255, 255, 255, 0.2);
        padding: 8px 12px;
        border-radius: 5px;
        display: inline-block;
    }
    
    .motorista-info {
        background-color: #e7f3ff;
        border-left: 4px solid #0d6efd;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 4px;
    }
    
    .destinos-box {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 12px;
        border-radius: 4px;
        margin-top: 10px;
    }
    
    .destino-item {
        display: flex;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #dee2e6;
    }
    
    .destino-item:last-child {
        border-bottom: none;
    }
    
    .destino-numero {
        background-color: #0d6efd;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        font-weight: bold;
        font-size: 0.85rem;
    }
    
    .horario-section {
        background-color: #f0f7ff;
        padding: 12px;
        border-radius: 4px;
        margin-top: 12px;
    }
    
    .horario-badge {
        display: inline-block;
        background-color: #28a745;
        color: white;
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 0.9rem;
        margin-right: 8px;
        margin-bottom: 5px;
    }
    
    .horario-badge.saida {
        background-color: #ffc107;
        color: #333;
    }
    
    .horario-badge.chegada {
        background-color: #28a745;
    }
    
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 15px;
    }
    
    .stat-box {
        background-color: #f8f9fa;
        padding: 12px;
        border-radius: 4px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #0d6efd;
    }
    
    .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .km-info {
        background-color: #e8f5e9;
        border-left: 4px solid #28a745;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 0.95rem;
    }
</style>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fa-solid fa-clock text-primary me-2"></i>Cronograma de Viagens em Rota
            </h2>
            
            <!-- Aviso de Acesso Público -->
            <div class="alert alert-success" style="border-left: 4px solid #10b981; margin-bottom: 2rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <i class="fa-solid fa-eye" style="font-size: 1.3rem; color: #10b981;"></i>
                    <div>
                        <strong><i class="fa-solid fa-info-circle me-1"></i>Acesso Permitido:</strong> 
                        Todos os usuários podem visualizar este cronograma em tempo real. 
                        {% if current_user.role != 'admin' %}
                        Para agendar um veículo, acesse <a href="{{ url_for('agendar_veiculo') }}" class="alert-link"><i class="fa-solid fa-calendar-plus me-1"></i>Novo Agendamento</a>.
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if viagens %}
        <div class="cronograma-grid">
            {% for v in viagens %}
            <div class="card viagem-card ativo shadow-sm">
                <div class="veiculo-header">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div><strong>Veículo em Uso</strong></div>
                            <div class="veiculo-placa mt-2">{{ v.PlacaVeiculo }}</div>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="status-badge status-em-rota">
                                <i class="fa-solid fa-circle-dot me-1"></i>EM ROTA
                            </span>
                            {% if current_user.role == 'admin' %}
                            <button type="button" class="btn btn-sm btn-danger ms-2" data-bs-toggle="modal" data-bs-target="#modalCancelar{{ loop.index }}" title="Cancelar viagem">
                                <i class="fa-solid fa-trash me-1"></i>Cancelar
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <!-- Informações do Motorista -->
                    <div class="motorista-info">
                        <div class="info-item">
                            <i class="fa-solid fa-user"></i>
                            <div>
                                <div class="info-label">Motorista Autorizado:</div>
                                <div class="info-value">{{ v.Motorista }}</div>
                            </div>
                        </div>
                        {% if v.AgendadoPor %}
                        <div class="info-item mt-2">
                            <i class="fa-solid fa-calendar-check"></i>
                            <div>
                                <div class="info-label">Agendado por:</div>
                                <div class="info-value">{{ v.AgendadoPor }}</div>
                            </div>
                        </div>
                        {% endif %}
                        {% if v.TelefoneContato %}
                        <div class="info-item mt-2">
                            <i class="fa-solid fa-phone"></i>
                            <div>
                                <div class="info-label">Contato:</div>
                                <div class="info-value">{{ v.TelefoneContato }}</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Data e Hora da Saída -->
                    <div class="horario-section">
                        <div class="mb-3">
                            <strong><i class="fa-solid fa-calendar-days text-primary me-2"></i>Data da Saída:</strong>
                            <span class="ms-2">{{ v.DataSaida }}</span>
                        </div>
                        <div>
                            <span class="horario-badge saida">
                                <i class="fa-solid fa-sign-out me-1"></i>Saída: {{ v.HoraSaida }}
                            </span>
                            {% if v.HoraChegada %}
                            <span class="horario-badge chegada">
                                <i class="fa-solid fa-sign-in me-1"></i>Chegada: {{ v.HoraChegada }}
                            </span>
                            {% else %}
                            <span class="horario-badge" style="background-color: #6c757d; color: white;">
                                <i class="fa-solid fa-hourglass-end me-1"></i>Chegada: Pendente
                            </span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Informações de Quilometragem -->
                    {% if v.KmInicial and v.KmFinal %}
                    <div class="km-info">
                        <div class="info-item">
                            <i class="fa-solid fa-gauge"></i>
                            <span><strong>KM Inicial:</strong> {{ v.KmInicial }} | <strong>KM Final:</strong> {{ v.KmFinal }} | <strong>Distância:</strong> {{ v.KmFinal|int - v.KmInicial|int }} km</span>
                        </div>
                    </div>
                    {% elif v.KmInicial %}
                    <div class="km-info">
                        <div class="info-item">
                            <i class="fa-solid fa-gauge"></i>
                            <span><strong>KM Inicial:</strong> {{ v.KmInicial }} | <strong>KM Final:</strong> Pendente</span>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Destinos -->
                    <div style="margin-top: 20px;">
                        <strong class="mb-2 d-block">
                            <i class="fa-solid fa-map-location-dot text-success me-2"></i>Locais de Parada / Destinos:
                        </strong>
                        <div class="destinos-box">
                            {% set destinos_list = v.Destinos.split(',') if v.Destinos else [] %}
                            {% if destinos_list|length > 0 %}
                                {% for destino in destinos_list %}
                                <div class="destino-item">
                                    <div class="destino-numero">{{ loop.index }}</div>
                                    <div class="destino-texto">{{ destino.strip() }}</div>
                                </div>
                                {% endfor %}
                            {% else %}
                            <div class="alert alert-info mb-0">Nenhum destino registrado</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Estatísticas Rápidas -->
                    <div class="stats-row mt-3">
                        <div class="stat-box">
                            <div class="stat-value">{{ v.Motorista[0] }}</div>
                            <div class="stat-label">Motorista</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">{{ destinos_list|length }}</div>
                            <div class="stat-label">Paradas</div>
                        </div>
                        {% if v.KmInicial and v.KmFinal %}
                        <div class="stat-box">
                            <div class="stat-value">{{ (v.KmFinal|int - v.KmInicial|int) }}</div>
                            <div class="stat-label">Distância (km)</div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Observações / Info do Passageiros -->
                    {% if v.Observacoes or v.Passageiros %}
                    <div class="alert alert-info mt-3 mb-0">
                        {% if v.Passageiros %}
                        <div><strong><i class="fa-solid fa-people-group me-2"></i>Passageiros:</strong> {{ v.Passageiros }}</div>
                        {% endif %}
                        {% if v.Observacoes %}
                        <div class="mt-2"><strong><i class="fa-solid fa-clipboard me-2"></i>Observações:</strong> {{ v.Observacoes }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="row">
            <div class="col-12">
                <div class="alert alert-success text-center" role="alert" style="padding: 60px 20px;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">
                        <i class="fa-solid fa-check-circle"></i>
                    </div>
                    <h3>Excelente! Nenhum veículo em rota no momento.</h3>
                    <p class="mt-3">Todos os veículos estão disponíveis para uso.</p>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Modais de Cancelamento de Viagens -->
{% if viagens %}
    {% for v in viagens %}
    <div class="modal fade" id="modalCancelar{{ loop.index }}" tabindex="-1" aria-labelledby="modalCancelarLabel{{ loop.index }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="modalCancelarLabel{{ loop.index }}">
                        <i class="fa-solid fa-warning me-2"></i>Cancelar Viagem
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja cancelar esta viagem?</p>
                    <div class="alert alert-warning">
                        <strong>Veículo:</strong> {{ v.PlacaVeiculo }}<br>
                        <strong>Motorista:</strong> {{ v.Motorista }}<br>
                        <strong>Data/Hora:</strong> {{ v.DataSaida }} às {{ v.HoraSaida }}
                    </div>
                    <p class="text-muted"><small>Esta ação não pode ser desfeita!</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não, Voltar</button>
                    <form action="/cancelar-viagem" method="POST" style="display: inline;">
                        <input type="hidden" name="viagem_id" value="{{ v.ID }}">
                        <button type="submit" class="btn btn-danger">
                            <i class="fa-solid fa-trash me-1"></i>Sim, Cancelar Viagem
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
{% endif %}

{% endblock %}